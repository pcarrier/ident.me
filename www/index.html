<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    <title>My public IP addresses &amp; browser data</title>
    <style>
      :root {
        --max-width: 70rem;
        --section-min-width: 22rem;
        --spacing-xs: 0.2rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --border-radius: 0.5rem;
        --shadow: 0 0 0.5rem #0001;
        --font-size-sm: 0.75rem;
        --font-size-base: 1rem;
        --font-size-lg: 1.2rem;
        --font-size-xl: 1.5rem;
      }

      a,
      button {
        cursor: pointer;
      }
      a {
        text-decoration: none;
      }

      body {
        font-family: sans-serif;
        font-variant-numeric: tabular-nums;
        font-variant-emoji: unicode;
        background: #eee;
        margin: 0;
      }

      .headsup {
        text-align: center;
        background: #ff4f00;
        color: #fff;
        padding: 0;
        margin: 0;
        display: block;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        max-height: 0;
        overflow: hidden;
        transition:
          max-height 0.5s ease-out;
      }

      .headsup.visible {
        max-height: 2rem;
      }

      .dismiss-button {
        background: none;
        border: 1px solid #fff;
        color: #fff;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
      }

      .dismiss-button:hover {
        background: #fff1;
      }

      h1 {
        text-align: center;
        background: #0077b6;
        color: #fff;
        padding: var(--spacing-sm) 0;
        margin: 0;
        font-size: var(--font-size-xl);
      }

      h2 {
        margin: 0;
        color: #0077b6;
        font-size: var(--font-size-lg);
      }

      h3 {
        margin: 0;
        font-size: var(--font-size-base);
      }

      dt {
        font-weight: bold;
      }
      dd {
        margin: 0 0 var(--spacing-sm) var(--spacing-md);
      }
      pre {
        white-space: pre-wrap;
        margin: 0;
      }

      iframe {
        border: 0;
        width: 100%;
        height: auto;
        aspect-ratio: 1;
        border-radius: var(--border-radius);
      }

      .stats {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: var(--spacing-sm);
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
        font-size: var(--font-size-sm);
      }

      .stats.visible {
        display: grid;
      }

      .section {
        background: #fff;
        flex: 1;
        min-width: var(--section-min-width);
        padding: var(--spacing-sm);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
      }

      main {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        max-width: var(--max-width);
        margin: 0 auto;
        padding: var(--spacing-sm);
      }

      #docs {
        text-align: center;
        margin: var(--spacing-sm);
      }

      .stats-link {
        display: inline-flex;
        align-items: center;
      }

      .stats-link .arrow {
        transition: transform 0.2s;
      }
      .stats-link.expanded .arrow {
        transform: rotate(180deg);
      }

      .stats article {
        background: #fff;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: var(--spacing-sm);
        display: grid;
        gap: var(--spacing-sm);
        align-content: start;
      }

      .stats canvas {
        width: 100%;
        height: 3rem;
      }

      .agent {
        cursor: default;
      }

      .agent:hover {
        text-decoration: underline;
      }

      .inter {
        font-style: italic;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="headsup">
      75 ‚≠ê on
      <a href="https://github.com/pcarrier/ident.me">GitHub</a> to get into
      <a href="https://brew.sh"><code>brew</code></a
      >. <span id="headsup-count"></span> Please help me get there. üôè
      <button class="dismiss-button" onclick="dismissHeadsUp()">Dismiss</button>
    </div>
    <h1>My public IP addresses &amp; browser data</h1>
    <main>
      <div class="section">
        <h2>IPv4</h2>
        <div id="v4"></div>
      </div>
      <div class="section">
        <h2>IPv6</h2>
        <div id="v6"></div>
      </div>
      <div class="section">
        <h2>Browser data</h2>
        <div id="browser">
          <dl>
            <dt>Timezone</dt>
            <dd>
              <script>
                document.write(
                  Intl.DateTimeFormat().resolvedOptions().timeZone
                );
              </script>
            </dd>
            <dt>Language</dt>
            <dd>
              <script>
                document.write(navigator.language);
              </script>
            </dd>
            <dt>JS user agent</dt>
            <dd>
              <script>
                document.write(navigator.userAgent);
              </script>
            </dd>
            <dt>Display</dt>
            <dd>
              <script>
                document.write(
                  `${screen.width}√ó${screen.height}√ó${screen.colorDepth}`
                );
              </script>
            </dd>
            <dt>Headers</dt>
            <dd>
              <pre id="headers"></pre>
              <script>
                fetch("https://srv.us/h")
                  .then((response) => response.text())
                  .then((text) => {
                    document.getElementById("headers").innerHTML = text;
                  });
              </script>
            </dd>
            <dt>Coordinates</dt>
            <dd id="browsercoord"><em>Unknown</em></dd>
          </dl>
          <button id="geolocate">Geolocate me</button>
        </div>
      </div>
    </main>
    <p id="docs"></p>
    <div class="stats">
      <p class="inter">Loading‚Ä¶</p>
    </div>
    <script>
      function escapeHTML(str) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return str.replace(/[&<>"']/g, (m) => map[m]);
      }

      function dismissHeadsUp() {
        localStorage.setItem("headsUpDismissed", "true");
        const headsup = document.querySelector(".headsup");
        headsup.classList.remove("visible");
      }

      if (localStorage.getItem("headsUpDismissed") !== "true") {
        fetch("https://api.github.com/repos/pcarrier/ident.me")
          .then((response) => response.json())
          .then((json) => {
            if (json.stargazers_count < 75) {
              document.querySelector("#headsup-count").innerHTML = `Still ${
                75 - json.stargazers_count
              } missing!`;
              document.querySelector(".headsup").classList.add("visible");
            }
          });
      }

      const delta = 1;
      const mirror = window.location.hostname.substring(4);
      const other = mirror == "ident.me" ? "tnedi.me" : "ident.me";
      document.getElementById("docs").innerHTML =
        `<a href="//api.${mirror}">documentation</a> ‚Äî <a href="//www.${other}">mirror</a> ‚Äî <a href="#" class="stats-link" onclick="toggleStats(event)">stats <span class="arrow">‚ñº</span></a>`;

      function render(json) {
        const {
          ip,
          aso,
          asn,
          continent,
          cc,
          country,
          city,
          postal,
          latitude,
          longitude,
          tz,
        } = json;
        const lat = parseFloat(latitude);
        const long = parseFloat(longitude);
        const maybe = (x) => (x ? x : "<i>unknown</i>");
        return `<dl>
                  <dt>Address</dt>
                  <dd><code><a href="#" class="copy" onclick="copyToClipboard(event, '${ip}')">${ip}<span class="copy-icon">üìã</span></a></code></dd>
                  <dt>Autonomous System (ISP)</dt>
                  <dd>${aso} (${asn})</dd>
                  <dt>Timezone</dt>
                  <dd>${tz}</dd>
                  <dt>Continent</dt>
                  <dd>${continent}</dd>
                  <dt>Country</dt>
                  <dd>${country} (${cc})</dd>
                  <dt>City</dt>
                  <dd>${maybe(city)}</dd>
                  <dt>Postal code</dt>
                  <dd>${maybe(postal)}</dd>
                  <dt>Coordinates</dt>
                  <dd>
                    ${lat}, ${long}
                    <br/>
                    <iframe referrerpolicy="no-referrer-when-downgrade" src="https://www.openstreetmap.org/export/embed.html?marker=${latitude},${longitude}&bbox=${
                      long - delta
                    },${lat - delta},${long + delta},${lat + delta}" allowfullscreen>
                    </iframe>
                  </dd>
                </dl>`;
      }

      function update(version) {
        const html = document.getElementById(version);
        html.innerHTML = `<p class="inter">Loading‚Ä¶</p>`;
        fetch(`https://${version}.ident.me/json`)
          .then((response) => response.json())
          .then((json) => {
            html.innerHTML = render(json);
          })
          .catch((error) => {
            html.innerHTML = `<b>Error:</b> ${error.message}`;
          });
      }

      function copyToClipboard(event, text) {
        event.preventDefault();
        navigator.clipboard.writeText(text).then(() => {
          const icon = event.target.querySelector(".copy-icon");
          icon.textContent = "‚úÖ";
          setTimeout(() => {
            icon.textContent = "üìã";
          }, 1000);
        });
      }

      ["v4", "v6"].forEach((v) => update(v));

      document.getElementById("geolocate").onclick = () => {
        navigator.geolocation.getCurrentPosition((position) => {
          const { latitude, longitude } = position.coords;
          const lat = parseFloat(latitude);
          const long = parseFloat(longitude);
          document.getElementById("browsercoord").innerHTML = `
              ${latitude}, ${longitude}
              <br/>
              <iframe referrerpolicy="no-referrer-when-downgrade" src="https://www.openstreetmap.org/export/embed.html?marker=${latitude},${longitude}&bbox=${
                long - delta
              },${lat - delta},${long + delta},${lat + delta}" allowfullscreen>
              </iframe>
          `;
        });
      };

      async function drawSparkline(canvasId, reqs, ips) {
        const canvas = document.getElementById(canvasId);
        const rect = canvas.getBoundingClientRect();

        // Set physical pixels to match CSS pixels
        canvas.width = rect.width;
        canvas.height = rect.height;

        const ctx = canvas.getContext("2d");

        const width = rect.width;
        const height = rect.height;
        const textPadding = 2;
        const circleRadius = 4;
        const graphPadding = circleRadius + 1;
        const fontSize = "1em";

        // Calculate text metrics for the actual texts we'll display
        ctx.font = `${fontSize} sans-serif`;
        const sampleReqsText = `reqs: ${reqs[0].toLocaleString()}`;
        const sampleIpsText = `IPs: ${ips[0].toLocaleString()}`;
        const reqsMetrics = ctx.measureText(sampleReqsText);
        const ipsMetrics = ctx.measureText(sampleIpsText);

        // Use the larger of the two texts for line height calculation
        const lineHeight = Math.max(
          reqsMetrics.fontBoundingBoxAscent &&
            reqsMetrics.fontBoundingBoxDescent
            ? (reqsMetrics.fontBoundingBoxAscent +
                reqsMetrics.fontBoundingBoxDescent) *
                1.2
            : reqsMetrics.width * 0.6,
          ipsMetrics.fontBoundingBoxAscent && ipsMetrics.fontBoundingBoxDescent
            ? (ipsMetrics.fontBoundingBoxAscent +
                ipsMetrics.fontBoundingBoxDescent) *
                1.2
            : ipsMetrics.width * 0.6
        );

        const textBaseOffset = Math.max(
          reqsMetrics.fontBoundingBoxAscent || reqsMetrics.width * 0.4,
          ipsMetrics.fontBoundingBoxAscent || ipsMetrics.width * 0.4
        );
        const textBoxHeight = textPadding * 2 + lineHeight * 2;

        const points = [];
        let hoveredPoint = null;

        function drawLine(data, color, yKey, maxValue) {
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 2;

          data.forEach((value, i) => {
            const x =
              graphPadding +
              (i * (width - 2 * graphPadding)) / (data.length - 1);
            const y =
              height -
              graphPadding -
              ((height - 2 * graphPadding) * value) / maxValue;

            if (!points[i]) points[i] = { x, reqs: reqs[i], ips: ips[i] };
            points[i][yKey] = y;

            ctx[i === 0 ? "moveTo" : "lineTo"](x, y);
          });
          ctx.stroke();
        }

        function draw() {
          ctx.clearRect(0, 0, width, height);

          drawLine(reqs, "#4CAF50", "y", Math.max(...reqs));
          drawLine(ips, "#2196F3", "y2", Math.max(...ips));

          if (hoveredPoint) {
            ctx.font = `${fontSize} sans-serif`;
            ctx.textAlign = "right";
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";

            const metrics = ctx.measureText(
              "reqs: " + hoveredPoint.reqs.toLocaleString()
            );
            const boxWidth = metrics.width + textPadding * 2;

            ctx.fillRect(
              width - boxWidth,
              textPadding,
              boxWidth,
              textBoxHeight
            );

            ["reqs", "IPs"].forEach((label, i) => {
              ctx.fillStyle = label === "reqs" ? "#4CAF50" : "#2196F3";
              ctx.fillText(
                `${label}: ${hoveredPoint[
                  label.toLowerCase()
                ].toLocaleString()}`,
                width - textPadding,
                textPadding + textBaseOffset + i * lineHeight
              );
            });
          }
        }

        draw();

        canvas.addEventListener("mousemove", (e) => {
          const mouseX =
            (e.clientX - canvas.getBoundingClientRect().left) *
            (canvas.width / rect.width);

          hoveredPoint = points.reduce((closest, point) => {
            const dist = Math.abs(mouseX - point.x);
            return dist < Math.abs(mouseX - closest.x) ? point : closest;
          });

          draw();

          // Draw hover indicators
          [
            { y: hoveredPoint.y, color: "#4CAF50" },
            { y: hoveredPoint.y2, color: "#2196F3" },
          ].forEach(({ y, color }) => {
            ctx.beginPath();
            ctx.arc(hoveredPoint.x, y, circleRadius, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
          });
        });

        canvas.addEventListener("mouseleave", () => {
          hoveredPoint = null;
          draw();
        });
      }

      async function toggleStats(event) {
        if (event) {
          event.preventDefault();
        }
        const stats = document.querySelector(".stats");
        const link = document.querySelector(".stats-link");
        const isHidden = !stats.classList.contains("visible");

        if (isHidden) {
          link.classList.add("expanded");
          stats.classList.add("visible");

          if (!stats.dataset.loaded) {
            await fetchAndDrawStats();
            stats.dataset.loaded = "true";
          }
        } else {
          link.classList.remove("expanded");
          stats.classList.remove("visible");
        }
      }

      // Track window resize to redraw charts
      let resizeTimeout;
      window.addEventListener("resize", () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (document.querySelector(".stats").classList.contains("visible")) {
            fetchAndDrawStats();
          }
        }, 100);
      });

      async function fetchAndDrawStats() {
        const stats = document.querySelector(".stats");

        try {
          const [identStats, tnediStats] = await Promise.all([
            fetch("https://ident.me/stats").then((r) => r.json()),
            fetch("https://tnedi.me/stats").then((r) => r.json()),
          ]);

          stats.innerHTML = `
            <article>
              <h3>ident.me hourly</h3>
              <canvas id="ident-hourly"></canvas>
            </article>
            <article>
              <h3>tnedi.me hourly</h3>
              <canvas id="tnedi-hourly"></canvas>
            </article>
            <article>
              <h3>ident.me daily</h3>
              <canvas id="ident-daily"></canvas>
            </article>
            <article>
              <h3>tnedi.me daily</h3>
              <canvas id="tnedi-daily"></canvas>
            </article>
            <article>
              <h3>ident.me user agents (sampled)</h3>
              <div id="ident-agents"></div>
            </article>
            <article>
              <h3>tnedi.me user agents (sampled)</h3>
              <div id="tnedi-agents"></div>
            </article>
          `;

          await Promise.all([
            drawSparkline(
              "ident-hourly",
              identStats.hourly.reqs,
              identStats.hourly.ips
            ),
            drawSparkline(
              "ident-daily",
              identStats.daily.reqs,
              identStats.daily.ips
            ),
            drawSparkline(
              "tnedi-hourly",
              tnediStats.hourly.reqs,
              tnediStats.hourly.ips
            ),
            drawSparkline(
              "tnedi-daily",
              tnediStats.daily.reqs,
              tnediStats.daily.ips
            ),
          ]);

          const formatAgents = (agents) => {
            return Object.entries(agents)
              .sort(([, a], [, b]) => b - a)
              .map(
                ([agent, count]) =>
                  `<span class="agent">${escapeHTML(
                    agent
                  )} (${count.toLocaleString()})</span>`
              )
              .join(", ");
          };

          document.getElementById("ident-agents").innerHTML = formatAgents(
            identStats.ua
          );
          document.getElementById("tnedi-agents").innerHTML = formatAgents(
            tnediStats.ua
          );
        } catch (err) {
          stats.innerHTML = '<p class="inter">Failed to load stats</p>';
        }
      }
    </script>
  </body>
</html>
